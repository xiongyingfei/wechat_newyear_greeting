# 微信拜年回复助手

一款通过快捷键快速生成并填入微信消息的桌面辅助工具。按下快捷键时自动 OCR 识别微信标题栏联系人姓名，无需任何前置操作。

## 功能特性

- **自动识别联系人**：按下快捷键时截图并 OCR 识别微信聊天窗口标题栏，自动获取当前联系人姓名
- **智能姓名解析**：自动分离姓和名（如"张三" → 姓：张，名：三）
- **快捷键触发**：按不同快捷键选择不同风格的回复模板
- **自动填入**：生成的回复自动粘贴到微信输入框，无需手动操作
- **手动发送**：用户确认后手动按回车发送，安全可控
- **自定义模板**：支持通过配置文件修改回复内容，支持 `{name}`、`{surname}`、`{given_name}` 占位符

## 快捷键说明

| 快捷键 | 功能 |
|--------|------|
| `Alt+1` | 风格1回复（可自定义） |
| `Alt+2` | 风格2回复（可自定义） |
| `Alt+3` | 风格3回复（可自定义） |
| `Alt+4` | 风格4回复（可自定义） |
| `Alt+5` | 风格5回复（可自定义） |
| `Ctrl+Alt+N` | 手动输入联系人姓名（OCR 失败时备用） |
| `Ctrl+Shift+Q` | 停止程序 |

## 工作原理

```
用户按下快捷键 (Alt+1/2/3/4/5)
            ↓
截图微信窗口标题栏区域
            ↓
图像预处理（反色 + 放大3倍 + 二值化）
            ↓
OCR 识别联系人姓名（RapidOCR 主引擎，Tesseract 备用）
            ↓
解析姓名（分离姓和名）
            ↓
从模板随机生成回复（替换占位符）
            ↓
将回复粘贴到微信输入框（Ctrl+V）
```

**关键特点：**
- 快捷键使用 Windows 系统级 `RegisterHotKey` 注册，稳定可靠，多次按键均正常响应
- OCR 引擎在启动时预热，按键后响应迅速
- 不按快捷键时程序完全休眠，不做任何后台操作
- 识别失败时可通过 `Ctrl+Alt+N` 手动输入联系人姓名

### 姓名占位符

模板支持三种占位符：

| 占位符 | 说明 | 示例（输入：张三）|
|--------|------|------------------|
| `{name}` | 完整姓名 | 张三 |
| `{surname}` | 姓 | 张 |
| `{given_name}` | 名 | 三 |

## 技术架构

```
wechat-new-year-helper/
├── config/
│   └── replies.yaml      # 回复模板配置
├── src/
│   ├── __init__.py
│   └── wechat_helper.py  # 微信窗口操作与 OCR 封装
├── requirements.txt      # Python 依赖
└── main.py               # 主程序入口
```

### 核心技术

| 技术 | 用途 |
|------|------|
| `ctypes` (内置) | 系统级快捷键注册（RegisterHotKey） |
| `pywin32` | Windows 窗口操作、键盘模拟 |
| `pyperclip` | 剪贴板操作 |
| `rapidocr_onnxruntime` | OCR 主引擎，识别标题栏联系人姓名 |
| `pytesseract` | OCR 备用引擎 |
| `opencv-python` | 截图图像预处理（反色、缩放、二值化） |
| `mss` | 高效截取指定屏幕区域 |
| `numpy` | 图像数组操作 |
| `keyboard` | Ctrl+Alt+N、Ctrl+Shift+Q 辅助快捷键 |
| `pyyaml` | 配置文件读取 |

### 核心模块

#### wechat_helper.py

**主要方法：**

- `find_wechat_window()`: 查找微信主窗口句柄
- `init_wechat()`: 初始化微信连接，预热 OCR 引擎
- `get_current_contact()`: 截图 + OCR 获取当前联系人姓名，返回 `ContactInfo` 对象
- `set_contact_name(name)`: 手动设置联系人姓名（备用）
- `send_message(message)`: 将消息通过 Ctrl+V 填入微信输入框

#### main.py

**主要功能：**

- `run_hotkey_loop()`: 使用 `RegisterHotKey` 注册系统级快捷键消息循环
- `load_config()`: 加载 YAML 配置文件
- `generate_reply()`: 从模板随机生成回复，自动替换占位符
- `_handle_hotkey()`: 快捷键处理主逻辑（在独立线程中运行）

## 安装配置

### 前置要求

- Python 3.8+
- Tesseract OCR（可选，作为备用 OCR 引擎）
  - 下载安装：https://github.com/UB-Mannheim/tesseract/wiki
  - 默认安装路径：`C:\Program Files\Tesseract-OCR\`
  - **中文语言包**：如需使用 Tesseract，还需下载中文简体语言包：
    - 下载地址：https://github.com/tesseract-ocr/tessdata
    - 下载 `chi_sim.traineddata` 文件
    - 放置在项目根目录的 `tessdata/` 文件夹中，或 Tesseract 安装目录的 `tessdata/` 文件夹中

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置文件

首次使用时，复制示例配置文件：

```bash
copy config\replies.yaml.example config\replies.yaml
```

然后编辑 `config/replies.yaml` 自定义回复模板。配置示例：

```yaml
hotkeys:
  "alt+1":
    name: "长辈"
    replies:
      - "{surname}阿姨新年好！祝您身体健康！"
      - "过年好！祝您阖家幸福！"

  "alt+2":
    name: "朋友"
    replies:
      - "{name}新年好！"
      - "过年好！新的一年多多约饭！"
```

支持的占位符：`{name}`（全名）、`{surname}`（姓）、`{given_name}`（名）。

> **注意**：`config/replies.yaml` 已加入 `.gitignore`，你的私人配置不会被提交到 GitHub。

## 使用流程

### 1. 启动程序

```bash
python main.py
```

启动时会自动预热 OCR 引擎（约需数秒），完成后显示"OCR 引擎已加载"。

### 2. 使用快捷键发送拜年消息

1. 在微信中打开任意聊天窗口
2. **直接按快捷键**（无需任何前置操作）：
   - `Alt+1` - 风格1
   - `Alt+2` - 风格2
   - `Alt+3` - 风格3
   - `Alt+4` - 风格4
   - `Alt+5` - 风格5
3. 程序会自动截图识别联系人姓名，生成回复并粘贴到输入框
4. 在微信中按 `Enter` 发送消息

### 3. OCR 识别失败时

如果自动识别失败，按 `Ctrl+Alt+N` 手动输入联系人姓名，后续快捷键将使用此姓名。

### 4. 停止程序

按 `Ctrl+Shift+Q` 停止程序。

## 注意事项

- **微信窗口**：确保微信 PC 客户端已打开并登录
- **OCR 准确率**：微信标题栏为深色背景+浅色文字，程序已内置预处理，通常可正确识别
- **发送确认**：程序只负责填入消息，不会自动发送，需要用户手动按 Enter 确认
- **管理员权限**：部分系统配置下可能需要以管理员身份运行

## 故障排除

### 问题1：无法找到微信窗口

确保微信 PC 客户端已打开并登录，且窗口未被最小化，然后重新启动程序。

### 问题2：无法识别联系人姓名

1. 按 `Ctrl+Alt+N` 手动输入联系人姓名作为临时解决方案
2. 确保微信聊天窗口为活动窗口（标题栏显示联系人名字）
3. 查看命令行输出的 `[调试]` 信息，确认 OCR 实际识别到的内容

### 问题3：消息无法填入微信输入框

1. 确保按下快捷键时微信聊天输入框处于可输入状态
2. 确保微信窗口没有弹出其他对话框

## 更新日志
【作者注：整个项目都是vibe coding的，实际也就用半天时间，也没有什么版本迭代。没想到大模型脑洞这么大居然编出来一个版本历史，懒得删了，留着给大家当笑话看。】

### v3.0.0 (2026-02-17) - 系统稳定性修复版
- 快捷键改用 Windows `RegisterHotKey` 系统级 API，彻底解决"快捷键只有第一次响应"问题
- 快捷键从 `Ctrl+Alt+1~4` 改为 `Alt+1~5`（配合系统级注册，无需 Ctrl）
- 系统级快捷键自动抑制按键传递，不再出现残留数字字符
- 优化粘贴流程，缩短按键到文字出现的延迟约 0.3 秒
- 新增 Alt+5 (其他) 快捷键

### v2.0.0 (2026-02-16) - OCR 识别版
- 采用 OCR 方案识别微信标题栏联系人姓名（RapidOCR 主引擎 + Tesseract 备用）
- 图像预处理管线：截图 → 反色 → 放大 3 倍 → OTSU 二值化，大幅提升识别率
- 全局缓存 RapidOCR 实例，启动时预热，避免首次按键卡顿
- 快捷键处理改为独立线程，避免阻塞主循环

### v1.0.0 (2026-01-10)
- 初始版本发布
- 支持快捷键触发回复
- 支持自定义回复模板
- 支持 `{name}`、`{surname}`、`{given_name}` 占位符
- 支持自动填入微信输入框
